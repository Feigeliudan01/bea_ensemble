---
title: "Get AEGIS datasets for MSBE simulations"
output: html_notebook
author: Yuqing Zhang
date: October 14, 2018
---

Processed AEGIS **microarray** datasets are stored on GEO with accession number GSE66499. We download this dataset using the *GEOquery* package.

```{r, results='hide'}
rm(list=ls())
setwd("~/Dropbox/Work/MultiStudy_BatchEffect/AEGIS_simbatch/")
sapply(c("GEOquery", "ggplot2", "limma"), require, character.only=TRUE)
source("helper.R")
####  Load data from GEO
aegis_obj <- getGEO(GEO="GSE66499")[[1]]
```

```{r}
cat("Number of samples in 2 studies")
print(table(substr(aegis_obj$title,1,2)))
```


### AEGIS-1

AEGIS-1 is already corrected with ComBat. We only use samples with unique identifies in AEGIS-1. 

```{r}
aegis1_data <- aegis_obj[, substr(aegis_obj$title,1,2)=="A1"]

# keep samples with unique identifies
unique_title <- names(table(substr(aegis1_data$title,1,7)))[table(substr(aegis1_data$title,1,7))==1]
aegis1_data <- aegis1_data[, substr(aegis1_data$title,1,7) %in% unique_title]
#which(table(substr(aegis1_data$title,1,7))!=1)
condition_1 <- pData(aegis1_data)[, "cancer_yes_no:ch1"]
condition_1 <- ifelse(condition_1=="Y", "Cancer", "Normal")

cat("Number of cancer and normal samples in AEGIS-1")
print(table(as.factor(condition_1)))
```

```{r}
pca_res_1 <- prcomp(t(exprs(aegis1_data)), center=TRUE, scale.=TRUE)
plt_obj_1 <- data.frame(PC1=pca_res_1$x[, 1], PC2=pca_res_1$x[, 2], Condition=condition_1)
ggplot(plt_obj_1, aes(x=PC1, y=PC2, color=Condition)) + 
  geom_point() +
  scale_color_manual(values=c('#E69F00', '#56B4E9')) +
  ggtitle("AEGIS-1 samples")
rm(pca_res_1)
```


### AEGIS-2

AEGIS-2 has no evidence of batch effect - all samples are processed in a single microarray batch, according to the paper (Data processing: RMA normalized; all run in a single microarray batch; identify outliers. Lung cancer prevalence in AEGIS-2: 78%).

```{r}
aegis2_data <- aegis_obj[, substr(aegis_obj$title,1,2)=="A2"]
condition_2 <- pData(aegis2_data)[, "cancer_yes_no:ch1"]
condition_2 <- ifelse(condition_2=="Y", "Cancer", "Normal")

cat("Number of cancer and normal samples in AEGIS-2")
print(table(as.factor(condition_2)))
```

```{r}
pca_res_2 <- prcomp(t(exprs(aegis2_data)), center=TRUE, scale.=TRUE)
plt_obj_2 <- data.frame(PC1=pca_res_2$x[, 1], PC2=pca_res_2$x[, 2], Condition=condition_2)
ggplot(plt_obj_2, aes(x=PC1, y=PC2, color=Condition)) + 
  geom_point() +
  scale_color_manual(values=c('#E69F00', '#56B4E9')) +
  ggtitle("AEGIS-2 samples")
rm(pca_res_2)
```


### Combine datasets

There are significant study effects between AEGIS-1 and AEGIS-2.

```{r}
####  Pooled PCA
pca_res_cmb <- prcomp(rbind(t(exprs(aegis1_data)), t(exprs(aegis2_data))), center=TRUE, scale.=TRUE)
condition_cmb <- c(condition_1, condition_2)
batch <- c(rep("AEGIS-1",ncol(aegis1_data)), rep("AEGIS-2",ncol(aegis2_data)))
plt_obj_cmb <- data.frame(PC1=pca_res_cmb$x[, 1], PC2=pca_res_cmb$x[, 2], 
                          Condition=condition_cmb, Batch=batch)
# color by condition, marker shape by batch
ggplot(plt_obj_cmb, aes(x=PC1, y=PC2)) + 
  geom_point(aes(color=Condition, shape=Batch)) +
  scale_shape_manual(values=c(16, 17))+
  scale_color_manual(values=c('#E69F00', '#56B4E9')) +
  ggtitle("Combined AEGIS 1 and 2")
rm(pca_res_cmb)
```



### Signal in the datasets

Due to a larger sample size (and no ComBat processing), we use AEGIS-2 as the training set. We only include top-100 DE genes in AEGIS-2 as the features to train prediction models (we selected these DE genes using *limma* in AEGIS-2 training only, then project them in AEGIS-1 test). We then designed hyper parameters for batch effect based on the statistical properties of the original datasets. 

```{r, message=FALSE}
##  Feature reduction: DE with limma
de_fit <- lmFit(exprs(aegis2_data), design=model.matrix(~factor(condition_2, levels=c("Normal", "Cancer"))))
de_fit <- eBayes(de_fit)
selected_genes <- rownames(topTable(de_fit, number=100))
sel_trn_dat <- exprs(aegis2_data)[selected_genes, ]
```

#### Mean batch effect

Range of biological signal (fold change of top-100 DE genes):

```{r, message=FALSE}
de_res <- topTable(de_fit, number=100)
print(round(range(exp(de_res$logFC)), 3))
print(round(median(exp(de_res$logFC[1:10])), 3))
```

Range of gene-wise mean:

```{r}
cat("Mean stats in Normal samples\n")
mean_seq <- apply(sel_trn_dat[, condition_2=="Normal"], 1, mean)
print(round(median(mean_seq), 3)); print(round(range(mean_seq), 3))
cat("Mean stats in Cancer samples\n")
mean_seq <- apply(sel_trn_dat[, condition_2=="Cancer"], 1, mean)
print(round(median(mean_seq), 3)); print(round(range(mean_seq), 3))
```

#### Variance batch effect

Variances of genes in one condition:

```{r}
cat("Variance stats in Normal samples\n")
var_seq <- apply(sel_trn_dat[, condition_2=="Normal"], 1, var)
print(round(median(var_seq), 3)); print(round(range(var_seq), 3))
cat("Variance stats in Cancer samples\n")
var_seq <- apply(sel_trn_dat[, condition_2=="Cancer"], 1, var)
print(round(median(var_seq), 3)); print(round(range(var_seq), 3))
```


### Save data and record session info

```{r}
test_expr <- exprs(aegis1_data)[selected_genes, ]
train_expr <- exprs(aegis2_data)[selected_genes, ]
y_test <- rep(0, length(condition_1)); y_test[condition_1=="Cancer"] <- 1; y_test=as.factor(y_test)
y_train <- rep(0, length(condition_2)); y_train[condition_2=="Cancer"] <- 1; y_train=as.factor(y_train)

save(train_expr, test_expr, y_train, y_test, 
     file="AEGIS_data.RData")

sessionInfo()
```

